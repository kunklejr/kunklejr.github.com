
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>NotNull Hibernate Annotation Validation Problems - Jeff Kunkle's Blog</title>
  <meta name="author" content="Jeff Kunkle">

  
  <meta name="description" content="I recently decided to try out Hibernate&#8217;s annotation-based validation framework. It seems like a great solution for ensuring consistent &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kunkle.org/blog/2006/07/11/notnull-hibernate-annotation-validation-problems/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Jeff Kunkle's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37321329-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Jeff Kunkle's Blog</a></h1>
  
    <h2>a blog about software and related stuff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kunkle.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/talks">Talks</a></li>
  <li><a href="https://github.com/kunklejr">Code</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">NotNull Hibernate Annotation Validation Problems</h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-07-11T08:59:58-04:00" pubdate data-updated="true">Jul 11<span>th</span>, 2006</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>
I recently decided to try out Hibernate&#8217;s annotation-based validation framework. It seems like a great solution for ensuring consistent validation of the domain model regardless of the presentation tier (web interface, web service, etc.). It very much reminds me of the declarative validation available within Rails model objects.
</p>
<p>
To make a long story short, things did not go as well as I had hoped using a Hibernate Core 3.2.0 CR2 and Hibernate Annotations 3.2.0 CR1 combination. I struggled for hours trying to figure out why I was getting a &#8220;not-null property references a null or transient value&#8221; error rather than a validation error when attempting to use the NotNull validation annotation. Eventually I discovered the problem was not that the NotNull validation wasn&#8217;t working properly, but that it wasn&#8217;t running at all.
</p>
<p>
In order for the annotation-based validation framework to execute, Hibernate Annotations provides a <code>ValidatePreInsertEventListener</code> and <code>ValidatePreUpdateEventListener</code> to fire the annotation validations prior to persisting any changes to the domain model. &#8220;Pre-insert&#8221; and &#8220;pre-update&#8221; events are fired after other events, in this case <code>SaveOrUpdateEvent</code>(s). By default, Hibernate uses the <code>DefaultSaveOrUpdateEventListener</code>, which is an extension of <code>AbstractSaveEventListener</code>. The <code>AbstractSaveEventListener</code> checks for null values corresponding to non-nullable database columns ( <code>AbstractSaveEventListener:284</code> ) before adding the insert or update events to the execution queue( <code>AbstractSaveEventListener:290</code> ) responsible for triggering pre-insert or pre-update event listeners. In case that didn&#8217;t make complete sense, the bottom line is the Hibernate Core checks entities against the null constraints of the database before the annotation-based validation framework has a chance to run.
</p>
<p>
Luckily, there is a workaround, although it feels like a bit of a hack. As I mentioned previously, the <code>DefaultSaveOrUpdateEventListener</code> gets a chance to run before any &#8220;pre-insert&#8221; or &#8220;pre-update&#8221; events so we can use that to our advantage. The following <code>SaveOrUpdateEventListener</code> simply extends the Hibernate Annotations-provided <code>ValidateEventListener</code> and calls the validation method on &#8220;save-update&#8221; events rather than &#8220;pre-insert&#8221; and &#8220;pre-update&#8221; events.
</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ValidationEventListener</span>
</span><span class='line'>    <span class="kd">extends</span> <span class="n">ValidateEventListener</span>
</span><span class='line'>    <span class="kd">implements</span> <span class="n">SaveOrUpdateEventListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSaveOrUpdate</span><span class="o">(</span><span class="n">SaveOrUpdateEvent</span> <span class="n">event</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">HibernateException</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">SessionImplementor</span> <span class="n">source</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">source</span><span class="o">.</span><span class="na">getPersistenceContext</span><span class="o">().</span><span class="na">reassociateIfUninitializedProxy</span><span class="o">(</span><span class="n">object</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// only validate the entity if it has been changed</span>
</span><span class='line'>      <span class="kd">final</span> <span class="n">Object</span> <span class="n">entity</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">source</span><span class="o">.</span><span class="na">getPersistenceContext</span><span class="o">().</span><span class="na">unproxyAndReassociate</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">entity</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getEntityMode</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
One extemely important thing to remember when using this workaround is that you must configure the <code>DefaultSaveOrUpdateEventListener</code> as the second &#8220;save-update&#8221; listener (following the <code>ValidationEventListener</code>) or your objects will never be persisted.
</p> 
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jeff Kunkle</span></span>

      








  


<time datetime="2006-07-11T08:59:58-04:00" pubdate data-updated="true">Jul 11<span>th</span>, 2006</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://kunkle.org/blog/2006/07/11/notnull-hibernate-annotation-validation-problems/" data-via="kunklejr" data-counturl="http://kunkle.org/blog/2006/07/11/notnull-hibernate-annotation-validation-problems/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2006/06/25/beware-of-xss-when-using/" title="Previous Post: XSS Vulnerabilities of JSP 2.0 Expressions">&laquo; XSS Vulnerabilities of JSP 2.0 Expressions</a>
      
      
        <a class="basic-alignment right" href="/blog/2006/11/29/start-with-something-new/" title="Next Post: Start with Something New">Start with Something New &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/08/28/nodejs-test-coverage-reporting-with-covershot/">NodeJS Test Coverage Reporting with CoverShot</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/14/tech-presentation-tip-3-mirror-displays/">Tech Presentation Tip 3 - Mirror Displays</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/06/tech-presentation-tip-2-no-apologies-or-caveats/">Tech Presentation Tip 2 - No Apologies or Caveats</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/26/tech-presentation-tip-1-avoid-screen-resolution-shock/">Tech Presentation Tip 1 - Avoid Screen Resolution Shock</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/12/introducing-db-meta-for-nodejs/">Introducing db-meta for NodeJS</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/kunklejr">@kunklejr</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'kunklejr',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("kunklejr", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/kunklejr" class="twitter-follow-button" data-show-count="false">Follow @kunklejr</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/108076180146802069516?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Jeff Kunkle -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
